<link rel="import" href="bower_components/polymer/polymer.html">

<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="bower_components/google-map/google-map.html">

<polymer-element name="crime-philly" attributes="">
  <template>

    <link rel="stylesheet" href="crime-philly.css">

    <core-ajax
      auto
      url="http://gis.phila.gov/ArcGIS/rest/services/PhilaGov/Police_Incidents_Last30/MapServer/0/query?text=&geometry=&geometryType=esriGeometryPoint&inSR=&spatialRel=esriSpatialRelIntersects&relationParam=&objectIds=&where=sector+NOT+LIKE+%27%25%5B%5E0-9%5D%25%27&time=&returnCountOnly=false&returnIdsOnly=false&returnGeometry=true&maxAllowableOffset=&outSR=&outFields=*&f=pjson"
      handleAs="json"
      on-core-response="{{dataLoaded}}">
    </core-ajax>

    <template if="{{mapReady}}">
      <google-map id="map" latitude="39.9522" longitude="-75.1639" fit>
        <template repeat="{{ crime in crimes }}">
          <google-map-marker
            latitude="{{crime.geometry.y}}"
            longitude="{{crime.geometry.x}}"
            title="">
            {{crime.attributes.TEXT_GENERAL_CODE}}
          </google-map-marker>
        </template>
      </google-map>
    </template>


  </template>
  <script>
    (function () {
      'use strict';
      var myDataRef = new Firebase('https://torid-torch-5520.firebaseio.com');
      Polymer({
        crimes: [],
        mapReady: false,

        dataLoaded: function( e ) {
          console.log( e.detail.response );
          var rawData = e.detail.response.features;
          for( var i = 0; i < rawData.length; i++ ) {

              this.crimes.push( rawData[i] );
              myDataRef.push({id: this.crimes[1].DC_KEY, title: this.crimes[i].attributes.TEXT_GENERAL_CODE, lat: this.crimes[i].geometry.y, lon: this.crimes[i].geometry.x});

          }
          this.mapReady = true;

        }

      });

    })();
  </script>
</polymer-element>
